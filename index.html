<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>AI Maths Exam with Working Out</title><style>body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    background-color: #f4f7f9;
    color: #333;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    min-height: 100vh;
    margin: 0;
    padding: 20px;
}

.app-container {
    background-color: white;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    width: 800px;
    max-width: 95%;
    padding: 30px;
}

h1 {
    color: #2c3e50;
    text-align: center;
    margin-bottom: 25px;
}

/* Stats Section */
.stats-container {
    background-color: #ecf0f1;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 30px;
    text-align: center;
}

#stats-display {
    padding: 15px;
    background: #fff;
    border-radius: 5px;
    margin-bottom: 15px;
}

#generate-exam-btn {
    background-color: #3498db;
    color: white;
    border: none;
    border-radius: 5px;
    padding: 12px 20px;
    cursor: pointer;
    font-size: 1em;
    transition: background-color 0.2s;
}
#generate-exam-btn:hover {
    background-color: #2980b9;
}

/* Quiz Section */
#quiz-container {
    text-align: center;
}

.working-out-container {
    text-align: left;
    margin: 25px 0;
}

#working-out-area {
    width: 100%;
    padding: 10px;
    font-family: inherit;
    font-size: 1em;
    border-radius: 5px;
    border: 1px solid #ccc;
    box-sizing: border-box; /* Important */
}

.btn-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 10px;
    margin: 20px 0;
}

.btn {
    background-color: #95a5a6;
    border: none;
    border-radius: 5px;
    padding: 15px;
    color: white;
    cursor: pointer;
    font-size: 1em;
    transition: background-color 0.2s;
}
.btn:hover:not(:disabled) {
    background-color: #7f8c8d;
}

.btn.correct { background-color: #2ecc71; }
.btn.incorrect { background-color: #e74c3c; }
.btn:disabled { cursor: not-allowed; opacity: 0.7; }

#ai-feedback-container {
    margin-top: 30px;
    padding: 15px;
    background-color: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    text-align: left;
}
#ai-feedback-container h3 { margin-top: 0; }
#ai-feedback { min-height: 20px; }

.hide { display: none; }</style></head><body><div class="app-container"><h1>Adaptive Maths Exam</h1><!-- Performance Stats Section --><div class="stats-container"><h2>Your Performance</h2><div id="stats-display">Click "Generate Exam" to start.</div><button id="generate-exam-btn">Generate New Exam</button>
        </div>

        <!-- Quiz Section -->
        <div id="quiz-container" class="hide">
            <h2 id="topic-title"></h2>
            <p id="question"></p>
            
            <div class="working-out-container">
                <label for="working-out-area">Show your working out here:</label>
                <textarea id="working-out-area" rows="5" placeholder="Type your steps here..."></textarea>
            </div>

            <div id="answer-buttons" class="btn-grid"></div>
            
            <div id="ai-feedback-container">
                <h3>AI Feedback</h3>
                <div id="ai-feedback">Waiting for your answer...</div>
            </div>

            <button id="next-btn" class="next-btn btn hide">Next Question</button>
        </div>
    </div>
    <script>// --- DOM ELEMENTS ---
const statsDisplay = document.getElementById('stats-display');
const generateExamBtn = document.getElementById('generate-exam-btn');
const quizContainer = document.getElementById('quiz-container');
const topicTitleElement = document.getElementById('topic-title');
const questionElement = document.getElementById('question');
const workingOutArea = document.getElementById('working-out-area');
const answerButtonsElement = document.getElementById('answer-buttons');
const aiFeedbackElement = document.getElementById('ai-feedback');
const nextButton = document.getElementById('next-btn');

// --- QUESTION BANK with Keywords for AI Analysis ---
const masterQuestionBank = [
    { topic: 'Algebra', question: 'Factorise x² - 81. This is a difference of two squares.', answers: [{ text: '(x - 9)(x + 9)', correct: true }, { text: '(x - 81)(x + 1)', correct: false }, { text: 'x(x - 81)', correct: false }, { text: '(x - 9)²', correct: false }], keywords: ['difference', 'squares', 'sqrt(81)', '9'] },
    { topic: 'Geometry', question: 'A circle has a radius of 5cm. What is its area? (Use π ≈ 3.14)', answers: [{ text: '78.5cm²', correct: true }, { text: '31.4cm', correct: false }, { text: '15.7cm²', correct: false }, { text: '25cm²', correct: false }], keywords: ['πr²', 'pi * r * r', '3.14', '5 * 5', '25'] },
    { topic: 'Ratio', question: 'Share £150 in the ratio 2:3.', answers: [{ text: '£60 : £90', correct: true }, { text: '£75 : £75', correct: false }, { text: '£50 : £100', correct: false }, { text: '£30 : £120', correct: false }], keywords: ['2+3', '5 parts', '150 / 5', '30', '2 * 30', '3 * 30'] },
    { topic: 'Probability', question: 'A bag has 4 red and 6 blue balls. A ball is picked. What is the probability it is NOT blue?', answers: [{ text: '4/10 or 2/5', correct: true }, { text: '6/10', correct: false }, { text: '4/6', correct: false }, { text: '1/4', correct: false }], keywords: ['total', '4+6', '10', 'red', '4/10', '2/5'] },
];

let currentExam = [];
let currentQuestionIndex = 0;

// --- STATE & STATS MANAGEMENT ---
function getPerformanceStats() {
    return JSON.parse(localStorage.getItem('mathsPerformance')) || {};
}

function updatePerformanceStats(topic, isCorrect) {
    const stats = getPerformanceStats();
    if (!stats[topic]) stats[topic] = { correct: 0, incorrect: 0 };
    isCorrect ? stats[topic].correct++ : stats[topic].incorrect++;
    localStorage.setItem('mathsPerformance', JSON.stringify(stats));
    displayStats();
}

function displayStats() {
    // This function can be expanded to show detailed stats as before
    statsDisplay.textContent = "Your performance is being tracked.";
}

// --- MOCK AI HTTP API with Working Out Analysis ---
function mockAIHttpApi(question, isCorrect, workingOut) {
    console.log("Sending data to AI:", { question, isCorrect, workingOut });

    return new Promise(resolve => {
        setTimeout(() => {
            let feedback = '';
            const workingOutLower = workingOut.toLowerCase();
            const keywordsFound = question.keywords.filter(kw => workingOutLower.includes(kw));

            if (isCorrect) {
                if (keywordsFound.length > 1) {
                    feedback = "Excellent! Your answer is correct and your working out shows a solid method.";
                } else {
                    feedback = "Correct! Your final answer is right. Remember to show your steps clearly to get full marks in an exam.";
                }
            } else { // Incorrect Answer
                if (keywordsFound.length >= question.keywords.length / 2) {
                    feedback = `Not quite, but you're on the right track! I can see from your working out that you used the correct method (I spotted '${keywordsFound.join(', ')}'). Double-check your calculations for a small error.`;
                } else if (keywordsFound.length > 0) {
                    feedback = `Your answer is incorrect. You have the right idea by mentioning '${keywordsFound.join(', ')}', but your method seems to have gone astray. Review the steps for this topic.`;
                } else {
                    feedback = "Your answer is incorrect, and I couldn't spot a clear method in your working out. It's best to review this topic from the start.";
                }
            }
            resolve({ feedback });
        }, 1000);
    });
}

// --- QUIZ LOGIC ---
function startExam() {
    // For this version, we'll just shuffle the master bank. The AI could be used to build a targeted exam as in the previous version.
    currentExam = [...masterQuestionBank].sort(() => Math.random() - 0.5);
    currentQuestionIndex = 0;
    quizContainer.classList.remove('hide');
    generateExamBtn.textContent = "Generate a New Exam";
    showQuestion();
}

function showQuestion() {
    resetState();
    const currentQuestion = currentExam[currentQuestionIndex];
    topicTitleElement.textContent = `Topic: ${currentQuestion.topic}`;
    questionElement.textContent = currentQuestion.question;

    currentQuestion.answers.forEach(answer => {
        const button = document.createElement('button');
        button.innerText = answer.text;
        button.classList.add('btn');
        if (answer.correct) button.dataset.correct = true;
        button.addEventListener('click', selectAnswer);
        answerButtonsElement.appendChild(button);
    });
}

function resetState() {
    aiFeedbackElement.textContent = 'Waiting for your answer...';
    workingOutArea.value = '';
    nextButton.classList.add('hide');
    while (answerButtonsElement.firstChild) {
        answerButtonsElement.removeChild(answerButtonsElement.firstChild);
    }
}

function selectAnswer(e) {
    const selectedBtn = e.target;
    const isCorrect = selectedBtn.dataset.correct === 'true';
    const currentQuestion = currentExam[currentQuestionIndex];
    const workingOut = workingOutArea.value;

    // Disable all buttons
    Array.from(answerButtonsElement.children).forEach(button => {
        button.disabled = true;
        if (button.dataset.correct) button.classList.add('correct');
        else if (button === selectedBtn) button.classList.add('incorrect');
    });

    updatePerformanceStats(currentQuestion.topic, isCorrect);
    
    // Get AI feedback
    aiFeedbackElement.textContent = "AI is analyzing your work...";
    mockAIHttpApi(currentQuestion, isCorrect, workingOut)
        .then(response => {
            aiFeedbackElement.textContent = response.feedback;
        });

    // Show next button
    if (currentQuestionIndex < currentExam.length - 1) {
        nextButton.classList.remove('hide');
    } else {
        nextButton.textContent = "Finish Exam";
        nextButton.classList.remove('hide');
    }
}

// --- EVENT LISTENERS ---
generateExamBtn.addEventListener('click', startExam);

nextButton.addEventListener('click', () => {
    currentQuestionIndex++;
    if (currentQuestionIndex < currentExam.length) {
        showQuestion();
    } else {
        quizContainer.classList.add('hide');
        generateExamBtn.textContent = "Take Another Exam";
    }
});

// --- INITIALIZE ---
displayStats();</script></body></html>
