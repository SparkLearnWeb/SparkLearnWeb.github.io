<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Maths Exam with Data Export/Import</title>
    <style>body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    background-color: #f4f7f9;
    color: #333;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    min-height: 100vh;
    margin: 0;
    padding: 20px;
}

.app-container {
    background-color: white;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    width: 800px;
    max-width: 95%;
    padding: 30px;
}

h1, h2 {
    color: #2c3e50;
    text-align: center;
}

/* Data Management Section */
.data-container {
    background-color: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
    text-align: center;
}
.data-btn {
    background-color: #1abc9c;
    color: white;
    border: none;
    border-radius: 5px;
    padding: 10px 15px;
    cursor: pointer;
    margin: 5px;
    transition: background-color 0.2s;
}
.data-btn:hover {
    background-color: #16a085;
}

/* Stats Section */
.stats-container {
    background-color: #ecf0f1;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 30px;
    text-align: center;
}

#stats-display {
    padding: 15px;
    background: #fff;
    border-radius: 5px;
    margin-bottom: 15px;
    white-space: pre-wrap; /* Allows formatted stats display */
}

#generate-exam-btn {
    background-color: #3498db;
    color: white;
    border: none;
    border-radius: 5px;
    padding: 12px 20px;
    cursor: pointer;
    font-size: 1em;
    transition: background-color 0.2s;
}
#generate-exam-btn:hover {
    background-color: #2980b9;
}

/* Quiz Section */
#quiz-container { text-align: center; }
.working-out-container { text-align: left; margin: 25px 0; }
#working-out-area {
    width: 100%;
    padding: 10px;
    font-family: inherit;
    font-size: 1em;
    border-radius: 5px;
    border: 1px solid #ccc;
    box-sizing: border-box;
}
.btn-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 10px; margin: 20px 0; }
.btn { background-color: #95a5a6; border: none; border-radius: 5px; padding: 15px; color: white; cursor: pointer; font-size: 1em; transition: background-color 0.2s; }
.btn:hover:not(:disabled) { background-color: #7f8c8d; }
.btn.correct { background-color: #2ecc71; }
.btn.incorrect { background-color: #e74c3c; }
.btn:disabled { cursor: not-allowed; opacity: 0.7; }
#ai-feedback-container { margin-top: 30px; padding: 15px; background-color: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px; text-align: left; }
#ai-feedback-container h3 { margin-top: 0; }
#ai-feedback { min-height: 20px; }
.hide { display: none; }</style>
</head>
<body>
    <div class="app-container">
        <h1>Adaptive Maths Exam</h1>

        <!-- Data Management Section -->
        <div class="data-container">
            <h2>Data Management</h2>
            <p>Save your progress to a file to move it between devices.</p>
            <button id="export-btn" class="data-btn">Export Progress</button>
            <button id="import-btn" class="data-btn">Import Progress</button>
            <input type="file" id="import-file" class="hide" accept=".json">
        </div>

        <!-- Performance Stats Section -->
        <div class="stats-container">
            <h2>Your Performance</h2>
            <div id="stats-display">Click "Generate Exam" or import data to start.</div>
            <button id="generate-exam-btn">Generate New Exam</button>
        </div>

        <!-- Quiz Section -->
        <div id="quiz-container" class="hide">
            <h2 id="topic-title"></h2>
            <p id="question"></p>
            
            <div class="working-out-container">
                <label for="working-out-area">Show your working out here:</label>
                <textarea id="working-out-area" rows="5" placeholder="Type your steps here..."></textarea>
            </div>

            <div id="answer-buttons" class="btn-grid"></div>
            
            <div id="ai-feedback-container">
                <h3>AI Feedback</h3>
                <div id="ai-feedback">Waiting for your answer...</div>
            </div>

            <button id="next-btn" class="next-btn btn hide">Next Question</button>
        </div>
    </div>
    <script>// --- DOM ELEMENTS ---
const exportBtn = document.getElementById('export-btn');
const importBtn = document.getElementById('import-btn');
const importFile = document.getElementById('import-file');
const statsDisplay = document.getElementById('stats-display');
const generateExamBtn = document.getElementById('generate-exam-btn');
const quizContainer = document.getElementById('quiz-container');
const topicTitleElement = document.getElementById('topic-title');
const questionElement = document.getElementById('question');
const workingOutArea = document.getElementById('working-out-area');
const answerButtonsElement = document.getElementById('answer-buttons');
const aiFeedbackElement = document.getElementById('ai-feedback');
const nextButton = document.getElementById('next-btn');

// --- DYNAMIC QUESTION GENERATION ---

// Helper function to get a random element from an array
function getRandom(arr) {
    return arr[Math.floor(Math.random() * arr.length)];
}

// Helper function to shuffle an array
function shuffle(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
}

const questionTemplates = [
    {
        topic: 'Algebra',
        generator: () => {
            const squares = [16, 25, 36, 49, 64, 81, 100, 121, 144];
            const numSquared = getRandom(squares);
            const num = Math.sqrt(numSquared);
            const questionText = `Factorise x² - ${numSquared}.`;
            
            const correctAnswer = `(x - ${num})(x + ${num})`;
            const distractors = [
                `(x - ${numSquared})(x + 1)`, // Common error
                `x(x - ${numSquared})`,
                `(x + ${num})²`,
                `(x - ${num})²`
            ];

            const answers = [{ text: correctAnswer, correct: true }];
            shuffle(distractors).slice(0, 3).forEach(d => answers.push({ text: d, correct: false }));

            return {
                topic: 'Algebra',
                question: questionText,
                answers: shuffle(answers),
                keywords: ['difference', 'squares', `sqrt(${numSquared})`, `${num}`]
            };
        }
    },
    {
        topic: 'Geometry',
        generator: () => {
            const radius = getRandom([3, 4, 5, 6, 7, 8, 10]);
            const area = (Math.PI * radius * radius).toFixed(1);
            const circumference = (2 * Math.PI * radius).toFixed(1);
            const diameterSquared = (radius * 2) * (radius * 2);

            const questionText = `A circle has a radius of ${radius}cm. What is its area? (Use π and round to 1 d.p.)`;
            const correctAnswer = `${area}cm²`;
            
            const answers = [
                { text: correctAnswer, correct: true },
                { text: `${circumference}cm²`, correct: false }, // Confuses with circumference
                { text: `${diameterSquared}cm²`, correct: false }, // Confuses radius with diameter
                { text: `${area}cm`, correct: false } // Incorrect unit
            ];
            
            return {
                topic: 'Geometry',
                question: questionText,
                answers: shuffle(answers),
                keywords: ['πr²', 'pi * r * r', `${radius} * ${radius}`]
            };
        }
    },
    {
        topic: 'Ratio',
        generator: () => {
            const ratioA = getRandom([2, 3, 4]);
            const ratioB = getRandom([5, 6, 7]);
            const totalParts = ratioA + ratioB;
            const multiplier = getRandom([10, 20, 30]);
            const totalAmount = totalParts * multiplier;
            
            const shareA = ratioA * multiplier;
            const shareB = ratioB * multiplier;

            const questionText = `Share £${totalAmount} in the ratio ${ratioA}:${ratioB}.`;
            const correctAnswer = `£${shareA} : £${shareB}`;

            const answers = [
                { text: correctAnswer, correct: true },
                { text: `£${shareB} : £${shareA}`, correct: false }, // Swapped ratio
                { text: `£${totalAmount / ratioA} : £${totalAmount / ratioB}`, correct: false }, // Incorrect division
                { text: `£${totalAmount / 2} : £${totalAmount / 2}`, correct: false } // Divided by 2
            ];

            return {
                topic: 'Ratio',
                question: questionText,
                answers: shuffle(answers),
                keywords: [`${ratioA}+${ratioB}`, `${totalParts} parts`, `${totalAmount} / ${totalParts}`]
            };
        }
    },
    {
        topic: 'Probability',
        generator: () => {
            const numA = getRandom([3, 4, 5, 6]);
            const numB = getRandom([7, 8, 9, 10]);
            const total = numA + numB;
            
            const questionText = `A bag has ${numA} red and ${numB} blue balls. What is the probability of picking a RED ball?`;
            const correctAnswer = `${numA}/${total}`;

            const answers = [
                { text: correctAnswer, correct: true },
                { text: `${numB}/${total}`, correct: false }, // Probability of the other event
                { text: `${numA}/${numB}`, correct: false }, // Ratio as a fraction
                { text: `${numB}/${numA}`, correct: false } // Inverse ratio
            ];
            
            return {
                topic: 'Probability',
                question: questionText,
                answers: shuffle(answers),
                keywords: ['total', `${numA}+${numB}`, `${total}`, 'red', `${numA}/${total}`]
            };
        }
    }
];

function generateQuestion() {
    const template = getRandom(questionTemplates);
    return template.generator();
}

let currentExam = [];
let currentQuestionIndex = 0;

// --- DATA MANAGEMENT FUNCTIONS (Same as before) ---
function exportData() {
    const data = getPerformanceStats();
    if (Object.keys(data).length === 0) {
        alert("No performance data to export yet!");
        return;
    }
    const jsonString = JSON.stringify(data, null, 2);
    const blob = new Blob([jsonString], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'maths-progress.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

function importData(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const importedData = JSON.parse(e.target.result);
            if (typeof importedData === 'object' && importedData !== null) {
                localStorage.setItem('mathsPerformance', JSON.stringify(importedData));
                displayStats();
                alert("Progress imported successfully!");
            } else {
                throw new Error("Invalid file format.");
            }
        } catch (error) {
            alert("Error importing file. Please ensure it's a valid progress file.");
            console.error(error);
        }
    };
    reader.readAsText(file);
    importFile.value = '';
}


// --- STATE & STATS MANAGEMENT (Same as before) ---
function getPerformanceStats() {
    return JSON.parse(localStorage.getItem('mathsPerformance')) || {};
}

function updatePerformanceStats(topic, isCorrect) {
    const stats = getPerformanceStats();
    if (!stats[topic]) stats[topic] = { correct: 0, incorrect: 0 };
    isCorrect ? stats[topic].correct++ : stats[topic].incorrect++;
    localStorage.setItem('mathsPerformance', JSON.stringify(stats));
}

function displayStats() {
    const stats = getPerformanceStats();
    if (Object.keys(stats).length === 0) {
        statsDisplay.textContent = 'No performance data found. Take a test to start!';
        return;
    }
    statsDisplay.textContent = JSON.stringify(stats, null, 2);
}

// --- SIMULATED AI & EXAM LOGIC ---
function mockAIHttpApi(performanceData) {
    console.log("Simulating AI analysis of data:", performanceData);
    return new Promise(resolve => {
        setTimeout(() => {
            const exam = [];
            const topics = shuffle(questionTemplates.map(t => t.topic)); // Get unique topics
            
            // Simple logic: generate one question per topic for variety
            for (let i = 0; i < 4; i++) {
                exam.push(generateQuestion());
            }
            resolve(exam);
        }, 500); // Simulate network delay
    });
}

async function startExam() {
    generateExamBtn.textContent = 'Generating...';
    generateExamBtn.disabled = true;

    const stats = getPerformanceStats();
    currentExam = await mockAIHttpApi(stats);
    currentQuestionIndex = 0;
    quizContainer.classList.remove('hide');
    showQuestion(currentExam[currentQuestionIndex]);

    generateExamBtn.textContent = 'Generate New Exam';
    generateExamBtn.disabled = false;
}

// --- UI FUNCTIONS (showQuestion, resetState, selectAnswer, provideAiFeedback) ---
// These are mostly the same as the fully-working previous version.

function showQuestion(question) {
    resetState();
    topicTitleElement.textContent = `Topic: ${question.topic}`;
    questionElement.textContent = question.question;
    question.answers.forEach(answer => {
        const button = document.createElement('button');
        button.innerText = answer.text;
        button.classList.add('btn');
        if (answer.correct) {
            button.dataset.correct = 'true';
        }
        button.addEventListener('click', selectAnswer);
        answerButtonsElement.appendChild(button);
    });
}

function resetState() {
    nextButton.classList.add('hide');
    aiFeedbackElement.textContent = "Waiting for your answer...";
    aiFeedbackElement.style.color = '#333';
    workingOutArea.value = '';
    while (answerButtonsElement.firstChild) {
        answerButtonsElement.removeChild(answerButtonsElement.firstChild);
    }
}

function selectAnswer(e) {
    const selectedButton = e.target;
    const isCorrect = selectedButton.dataset.correct === 'true';
    
    updatePerformanceStats(currentExam[currentQuestionIndex].topic, isCorrect);

    Array.from(answerButtonsElement.children).forEach(button => {
        button.disabled = true;
        setStatusClass(button, button.dataset.correct === 'true');
    });

    provideAiFeedback(isCorrect);

    if (currentExam.length > currentQuestionIndex + 1) {
        nextButton.classList.remove('hide');
    } else {
        generateExamBtn.textContent = 'Take Another Exam!';
        displayStats(); // Update stats display at the end of the exam
    }
}

function setStatusClass(element, correct) {
    if (correct) {
        element.classList.add('correct');
    } else {
        element.classList.add('incorrect');
    }
}

function provideAiFeedback(isCorrect) {
    const question = currentExam[currentQuestionIndex];
    const userWorking = workingOutArea.value.toLowerCase();
    let feedback = '';

    if (isCorrect) {
        feedback = 'Correct! Well done.';
        aiFeedbackElement.style.color = '#27ae60';
        const hasCorrectWorking = question.keywords.some(kw => userWorking.includes(kw));
        if (hasCorrectWorking) {
            feedback += ' Your working out shows you understand the method.';
        } else if (userWorking.length > 0) {
            feedback += ' Your working out doesn\'t seem to match the standard method, but you got the right answer, which is great!';
        }
    } else {
        feedback = 'Not quite. ';
        aiFeedbackElement.style.color = '#c0392b';
        const hasPartialWorking = question.keywords.some(kw => userWorking.includes(kw));
        if (hasPartialWorking) {
            feedback += 'It looks like you were on the right track in your working out. Double-check your calculations.';
        } else {
            const correctAnswer = question.answers.find(a => a.correct).text;
            feedback += `The correct answer is ${correctAnswer}. Let's review the method. Key steps often involve: ${question.keywords.join(', ')}.`;
        }
    }
    aiFeedbackElement.textContent = feedback;
}


// --- EVENT LISTENERS ---
exportBtn.addEventListener('click', exportData);
importBtn.addEventListener('click', () => importFile.click());
importFile.addEventListener('change', importData);

generateExamBtn.addEventListener('click', startExam);

nextButton.addEventListener('click', () => {
    currentQuestionIndex++;
    showQuestion(currentExam[currentQuestionIndex]);
});

// --- INITIALIZE ---
displayStats();
</script>
</body>
</html>
