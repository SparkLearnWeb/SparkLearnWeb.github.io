<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Maths Exam with Data Export/Import</title>
    <style>body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    background-color: #f4f7f9;
    color: #333;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    min-height: 100vh;
    margin: 0;
    padding: 20px;
}

.app-container {
    background-color: white;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    width: 800px;
    max-width: 95%;
    padding: 30px;
}

h1, h2 {
    color: #2c3e50;
    text-align: center;
}

/* Data Management Section */
.data-container {
    background-color: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
    text-align: center;
}
.data-btn {
    background-color: #1abc9c;
    color: white;
    border: none;
    border-radius: 5px;
    padding: 10px 15px;
    cursor: pointer;
    margin: 5px;
    transition: background-color 0.2s;
}
.data-btn:hover {
    background-color: #16a085;
}

/* Stats Section */
.stats-container {
    background-color: #ecf0f1;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 30px;
    text-align: center;
}

#stats-display {
    padding: 15px;
    background: #fff;
    border-radius: 5px;
    margin-bottom: 15px;
    white-space: pre-wrap; /* Allows formatted stats display */
}

#generate-exam-btn {
    background-color: #3498db;
    color: white;
    border: none;
    border-radius: 5px;
    padding: 12px 20px;
    cursor: pointer;
    font-size: 1em;
    transition: background-color 0.2s;
}
#generate-exam-btn:hover {
    background-color: #2980b9;
}

/* Quiz Section */
#quiz-container { text-align: center; }
.working-out-container { text-align: left; margin: 25px 0; }
#working-out-area {
    width: 100%;
    padding: 10px;
    font-family: inherit;
    font-size: 1em;
    border-radius: 5px;
    border: 1px solid #ccc;
    box-sizing: border-box;
}
.btn-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 10px; margin: 20px 0; }
.btn { background-color: #95a5a6; border: none; border-radius: 5px; padding: 15px; color: white; cursor: pointer; font-size: 1em; transition: background-color 0.2s; }
.btn:hover:not(:disabled) { background-color: #7f8c8d; }
.btn.correct { background-color: #2ecc71; }
.btn.incorrect { background-color: #e74c3c; }
.btn:disabled { cursor: not-allowed; opacity: 0.7; }
#ai-feedback-container { margin-top: 30px; padding: 15px; background-color: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px; text-align: left; }
#ai-feedback-container h3 { margin-top: 0; }
#ai-feedback { min-height: 20px; }
.hide { display: none; }</style>
</head>
<body>
    <div class="app-container">
        <h1>Adaptive Maths Exam</h1>

        <!-- Data Management Section -->
        <div class="data-container">
            <h2>Data Management</h2>
            <p>Save your progress to a file to move it between devices.</p>
            <button id="export-btn" class="data-btn">Export Progress</button>
            <button id="import-btn" class="data-btn">Import Progress</button>
            <input type="file" id="import-file" class="hide" accept=".json">
        </div>

        <!-- Performance Stats Section -->
        <div class="stats-container">
            <h2>Your Performance</h2>
            <div id="stats-display">Click "Generate Exam" or import data to start.</div>
            <button id="generate-exam-btn">Generate New Exam</button>
        </div>

        <!-- Quiz Section -->
        <div id="quiz-container" class="hide">
            <h2 id="topic-title"></h2>
            <p id="question"></p>
            
            <div class="working-out-container">
                <label for="working-out-area">Show your working out here:</label>
                <textarea id="working-out-area" rows="5" placeholder="Type your steps here..."></textarea>
            </div>

            <div id="answer-buttons" class="btn-grid"></div>
            
            <div id="ai-feedback-container">
                <h3>AI Feedback</h3>
                <div id="ai-feedback">Waiting for your answer...</div>
            </div>

            <button id="next-btn" class="next-btn btn hide">Next Question</button>
        </div>
    </div>
    <script>// --- DOM ELEMENTS ---
const exportBtn = document.getElementById('export-btn');
const importBtn = document.getElementById('import-btn');
const importFile = document.getElementById('import-file');
const statsDisplay = document.getElementById('stats-display');
const generateExamBtn = document.getElementById('generate-exam-btn');
const quizContainer = document.getElementById('quiz-container');
const topicTitleElement = document.getElementById('topic-title');
const questionElement = document.getElementById('question');
const workingOutArea = document.getElementById('working-out-area');
const answerButtonsElement = document.getElementById('answer-buttons');
const aiFeedbackElement = document.getElementById('ai-feedback');
const nextButton = document.getElementById('next-btn');

// --- QUESTION BANK --- (Same as before)
const masterQuestionBank = [
    { topic: 'Algebra', question: 'Factorise x² - 81. This is a difference of two squares.', answers: [{ text: '(x - 9)(x + 9)', correct: true }, { text: '(x - 81)(x + 1)', correct: false }, { text: 'x(x - 81)', correct: false }, { text: '(x - 9)²', correct: false }], keywords: ['difference', 'squares', 'sqrt(81)', '9'] },
    { topic: 'Geometry', question: 'A circle has a radius of 5cm. What is its area? (Use π ≈ 3.14)', answers: [{ text: '78.5cm²', correct: true }, { text: '31.4cm', correct: false }, { text: '15.7cm²', correct: false }, { text: '25cm²', correct: false }], keywords: ['πr²', 'pi * r * r', '3.14', '5 * 5', '25'] },
    { topic: 'Ratio', question: 'Share £150 in the ratio 2:3.', answers: [{ text: '£60 : £90', correct: true }, { text: '£75 : £75', correct: false }, { text: '£50 : £100', correct: false }, { text: '£30 : £120', correct: false }], keywords: ['2+3', '5 parts', '150 / 5', '30', '2 * 30', '3 * 30'] },
    { topic: 'Probability', question: 'A bag has 4 red and 6 blue balls. A ball is picked. What is the probability it is NOT blue?', answers: [{ text: '4/10 or 2/5', correct: true }, { text: '6/10', correct: false }, { text: '4/6', correct: false }, { text: '1/4', correct: false }], keywords: ['total', '4+6', '10', 'red', '4/10', '2/5'] },
];

let currentExam = [];
let currentQuestionIndex = 0;

// --- DATA MANAGEMENT FUNCTIONS ---
function exportData() {
    const data = getPerformanceStats();
    if (Object.keys(data).length === 0) {
        alert("No performance data to export yet!");
        return;
    }
    const jsonString = JSON.stringify(data, null, 2); // Pretty-print JSON
    const blob = new Blob([jsonString], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = 'maths-progress.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url); // Clean up
}

function importData(event) {
    const file = event.target.files[0];
    if (!file) {
        return;
    }
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const importedData = JSON.parse(e.target.result);
            // Basic validation
            if (typeof importedData === 'object' && importedData !== null) {
                localStorage.setItem('mathsPerformance', JSON.stringify(importedData));
                displayStats();
                alert("Progress imported successfully!");
            } else {
                throw new Error("Invalid file format.");
            }
        } catch (error) {
            alert("Error importing file. Please make sure it is a valid progress file.");
            console.error(error);
        }
    };
    reader.readAsText(file);
    importFile.value = ''; // Reset file input
}

// --- STATE & STATS MANAGEMENT --- (getPerformanceStats & updatePerformanceStats are the same)
function getPerformanceStats() {
    return JSON.parse(localStorage.getItem('mathsPerformance')) || {};
}

function updatePerformanceStats(topic, isCorrect) {
    const stats = getPerformanceStats();
    if (!stats[topic]) stats[topic] = { correct: 0, incorrect: 0 };
    isCorrect ? stats[topic].correct++ : stats[topic].incorrect++;
    localStorage.setItem('mathsPerformance', JSON.stringify(stats));
    displayStats();
}

function displayStats() {
    const stats = getPerformanceStats();
    if (Object.keys(stats).length === 0) {
        statsDisplay.textContent = 'No performance data found. Take a test to start!';
        return;
    }
    statsDisplay.textContent = JSON.stringify(stats, null, 2);
}

// All other functions (mockAIHttpApi, startExam, showQuestion, resetState, selectAnswer) remain the same as the previous version.

// --- EVENT LISTENERS ---
exportBtn.addEventListener('click', exportData);
importBtn.addEventListener('click', () => importFile.click()); // Trigger hidden file input
importFile.addEventListener('change', importData);
generateExamBtn.addEventListener('click', startExam);
nextButton.addEventListener('click', () => { /* ... same as before ... */ });

// --- INITIALIZE ---
displayStats();
</script>
</body>
</html>
